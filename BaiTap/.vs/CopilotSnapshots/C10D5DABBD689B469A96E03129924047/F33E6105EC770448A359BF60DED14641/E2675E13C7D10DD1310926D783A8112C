# HƯỚNG DẪN LẬP TRÌNH QUẢN LÝ DỮ LIỆU - TEMPLATE TỔNG QUÁT

## 📋 MỤC LỤC
1. [Tổng quan Pattern](#tổng-quan-pattern)
2. [Cấu trúc dữ liệu linh hoạt](#cấu-trúc-dữ-liệu-linh-hoạt)
3. [Patterns chung cho mọi bài](#patterns-chung-cho-mọi-bài)
4. [Ví dụ ứng dụng cụ thể](#ví-dụ-ứng-dụng-cụ-thể)
5. [Xử lý lỗi & Logging](#xử-lý-lỗi--logging)
6. [Tips và Best Practices](#tips-và-best-practices)

---

## 🎯 TỔNG QUAN PATTERN

### Pattern này áp dụng cho:
- ✅ **Quản lý đối tượng**: Sách, Sinh viên, Sản phẩm, Nhân viên, Xe, v.v.
- ✅ **CRUD Operations**: Create, Read, Update, Delete
- ✅ **Tìm kiếm theo nhiều tiêu chí**: Tên, ID, loại, người sở hữu, v.v.
- ✅ **Kiểm tra điều kiện**: Quá hạn, hết hạn, còn hàng, đủ điều kiện, v.v.
- ✅ **Logging & Tracking**: Ghi nhận mọi thao tác

### Luồng chung:
```
1. Đọc dữ liệu từ file → Mảng động
2. Hiển thị & cho phép tìm kiếm/lọc
3. User chọn → Thực hiện nghiệp vụ
4. Cập nhật dữ liệu
5. Kiểm tra điều kiện (nếu có)
6. Ghi log & lưu kết quả
```

---

## 📊 CẤU TRÚC DỮ LIỆU LINH HOẠT

### Pattern 1: Đối tượng chính (Main Entity)

```cpp
// Template chung
struct <TenDoiTuong>
{
    string id;              // ID/Mã số duy nhất
    string ten;             // Tên đối tượng
    string loai;            // Phân loại (nếu có)
    string nguoiLienQuan;   // Người sở hữu/quản lý
    int soLuong;            // Số lượng/Điểm/Giá trị số
    string trangThai;       // Trạng thái (nếu có)
};

// VÍ DỤ CỤ THỂ:

// 1. Quản lý sách
struct Sach {
    string maSach;          // id
    string tenSach;         // ten
    string theLoai;         // loai
    string tenDocGia;       // nguoiLienQuan
    int soLuong;            // soLuong
    string tinhTrang;       // trangThai
);

// 2. Quản lý sinh viên
struct SinhVien {
    string maSV;            // id
    string hoTen;           // ten
    string nganh;           // loai
    string giangVien;       // nguoiLienQuan
    int diem;               // soLuong
    string xepLoai;         // trangThai
};

// 3. Quản lý sản phẩm
struct SanPham {
    string maSP;            // id
    string tenSP;           // ten
    string danhMuc;         // loai
    string nhaCungCap;      // nguoiLienQuan
    int soLuongKho;         // soLuong
    string tinhTrang;       // trangThai
};

// 4. Quản lý xe
struct Xe {
    string bienSo;          // id
    string tenXe;           // ten
    string loaiXe;          // loai
    string chuXe;           // nguoiLienQuan
    int namSanXuat;         // soLuong
    string trangThai;       // trangThai
};
```

### Pattern 2: Giao dịch/Phiếu (Transaction)

```cpp
// Template chung
struct <TenGiaoDich>
{
    string ngayBatDau;      // Ngày bắt đầu
    string ngayKetThuc;     // Ngày kết thúc/deadline
    string nguoiThucHien;   // Người thực hiện (optional)
    string ghiChu;          // Ghi chú (optional)
};

// VÍ DỤ:

// 1. Phiếu mượn sách
struct PhieuMuon {
    string ngayMuon;
    string ngayTra;
    string nguoiMuon;
    string tenSach;
};

// 2. Hóa đơn
struct HoaDon {
    string ngayMua;
    string ngayGiaoHang;
    string khachHang;
    string sanPham;
};

// 3. Đăng ký môn học
struct DangKyMonHoc {
    string ngayDangKy;
    string ngayKetThuc;
    string sinhVien;
    string monHoc;
};
```

---

## 🔧 PATTERNS CHUNG CHO MỌI BÀI

### 1. ĐỌC FILE (UNIVERSAL READ PATTERN)

```cpp
void DocFile<TenDoiTuong>(DoiTuong* ds, int& dem)
{
    try {
        ifstream inFile("data.txt");
        
        // PATTERN: Fallback tìm file
        if (!inFile.is_open())
            inFile.open("../data.txt");
            
        if (!inFile.is_open())
            throw runtime_error("Khong the mo file!");
        
        dem = 0;  // ← CRITICAL: Luôn reset về 0
        string line;
        
        while (getline(inFile, line))
        {
            // PATTERN: Parse CSV động
            string fields[MAX_FIELDS];  // Mảng chứa các trường
            int fieldIndex = 0;
            string currentField = "";
            
            for (int i = 0; i < line.length(); i++)
            {
                if (line[i] == ',')  // Delimiter
                {
                    fields[fieldIndex++] = currentField;
                    currentField = "";
                }
                else
                    currentField += line[i];
            }
            fields[fieldIndex] = currentField;  // Field cuối cùng
            
            // Gán vào struct (tùy thuộc số field)
            ds[dem].field1 = fields[0];
            ds[dem].field2 = fields[1];
            // ... các field khác
            
            // PATTERN: Convert string → số với try-catch
            try {
                ds[dem].soLuong = stoi(fields[n]);
            }
            catch (...) {
                ds[dem].soLuong = 0;  // Default value
            }
            
            dem++;
        }
        
        inFile.close();
        GhiLog("Doc thanh cong: " + to_string(dem) + " ban ghi");
    }
    catch (exception& e) {
        GhiLog("Loi: " + string(e.what()));
    }
}
```

**Biến thể cho các định dạng khác:**
```cpp
// CSV với nhiều delimiter
char delimiters[] = {',', ';', '|', '\t'};

// Fixed-width format
string field1 = line.substr(0, 10);
string field2 = line.substr(10, 20);

// JSON-like format
// Tìm key-value pairs
size_t pos = line.find(":");
string key = line.substr(0, pos);
string value = line.substr(pos + 1);
```

---

### 2. TÌM KIẾM & LỌC (UNIVERSAL SEARCH PATTERN)

```cpp
void TimKiem(DoiTuong* ds, int dem)
{
    string tieuChi;
    cout << "Tim kiem theo (ten/id/loai/nguoi): ";
    cin >> tieuChi;
    
    if (tieuChi == "ten")
    {
        // PATTERN 1: Hiển thị tất cả các option duy nhất
        cout << "Danh sach ten:" << endl;
        for (int i = 0; i < dem; i++)
        {
            // Kiểm tra trùng lặp
            bool daTonTai = false;
            for (int j = 0; j < i; j++)
            {
                if (ds[i].ten == ds[j].ten)
                {
                    daTonTai = true;
                    break;
                }
            }
            if (!daTonTai)
                cout << ds[i].ten << endl;
        }
        
        // User chọn
        string tenChon;
        cout << "Nhap ten: ";
        cin >> tenChon;
        
        // Hiển thị kết quả
        cout << "Ket qua tim kiem:" << endl;
        for (int i = 0; i < dem; i++)
        {
            if (ds[i].ten == tenChon)
                HienThi(ds[i]);
        }
    }
    else if (tieuChi == "loai")
    {
        // Tương tự nhưng filter theo loai
        // ...
    }
    // ... các tiêu chí khác
}
```

**Pattern loại bỏ trùng lặp TỔNG QUÁT:**
```cpp
// Dùng cho BẤT KỲ field nào
template<typename T>
void HienThiKhongTrung(DoiTuong* ds, int dem, 
                       string DoiTuong::*field)
{
    for (int i = 0; i < dem; i++)
    {
        bool daTonTai = false;
        for (int j = 0; j < i; j++)
        {
            if (ds[i].*field == ds[j].*field)
            {
                daTonTai = true;
                break;
            }
        }
        if (!daTonTai)
            cout << ds[i].*field << endl;
    }
}

// Sử dụng:
HienThiKhongTrung(dsSach, dem, &Sach::tenDocGia);
HienThiKhongTrung(dsSach, dem, &Sach::theLoai);
```

---

### 3. CẬP NHẬT DỮ LIỆU (UNIVERSAL UPDATE PATTERN)

```cpp
void CapNhat(DoiTuong* ds, int dem, string idDaChon, int giaTri)
{
    // PATTERN: Tìm và cập nhật CHỈ 1 item
    for (int i = 0; i < dem; i++)
    {
        if (ds[i].id == idDaChon)
        {
            ds[i].soLuong -= giaTri;  // Hoặc +=, =, etc.
            GhiLog("Cap nhat: " + idDaChon);
            break;  // ← CRITICAL: Dừng ngay
        }
    }
    
    // Ghi lại file (CHỈ ghi `dem` dòng)
    ofstream outFile("data.txt");
    for (int i = 0; i < dem; i++)  // ← ĐÚNG
    {
        outFile << ds[i].field1 << ", "
                << ds[i].field2 << ", "
                << ds[i].soLuong << endl;
    }
    outFile.close();
}
```

**Các loại cập nhật:**
```cpp
// 1. Giảm số lượng (mượn sách, bán hàng)
ds[i].soLuong -= giaTri;

// 2. Tăng số lượng (trả sách, nhập kho)
ds[i].soLuong += giaTri;

// 3. Thay đổi trạng thái
ds[i].nguoiLienQuan = nguoiMoi;

// 4. Cập nhật người liên quan
ds[i].nguoiLienQuan = nguoiMoi;

// 5. Xóa (đánh dấu deleted)
ds[i].trangThai = "DaXoa";
// Hoặc thực sự xóa khỏi mảng
for (int j = i; j < dem - 1; j++)
    ds[j] = ds[j + 1];
dem--;
```

---

### 4. KIỂM TRA ĐIỀU KIỆN (UNIVERSAL VALIDATION PATTERN)

#### 4.1. So sánh ngày tháng

```cpp
bool KiemTraQuaHan(string ngayDeadline)
{
    // Parse ngày deadline
    int ngayDL, thangDL, namDL;
    ParseDate(ngayDeadline, ngayDL, thangDL, namDL);
    
    // Lấy ngày hiện tại
    int ngayHT, thangHT, namHT;
    LayNgayHienTai(ngayHT, thangHT, namHT);
    
    // So sánh: Năm → Tháng → Ngày
    if (namDL < namHT) return true;
    if (namDL == namHT)
    {
        if (thangDL < thangHT) return true;
        if (thangDL == thangHT && ngayDL < ngayHT)
            return true;
    }
    return false;
}

// Hàm parse date TỔNG QUÁT
void ParseDate(string date, int& day, int& month, int& year)
{
    string d = "", m = "", y = "";
    int part = 0;
    
    for (char c : date)
    {
        if (c == '/' || c == '-')
            part++;
        else
        {
            if (part == 0) d += c;
            else if (part == 1) m += c;
            else if (part == 2) y += c;
        }
    }
    
    try {
        day = stoi(d);
        month = stoi(m);
        year = stoi(y);
    }
    catch (...) {
        day = month = year = 0;
    }
}
```

**Ứng dụng:**
- ✅ Kiểm tra quá hạn trả sách
- ✅ Kiểm tra hết hạn thẻ thành viên
- ✅ Kiểm tra deadline nộp bài
- ✅ Kiểm tra hạn sử dụng sản phẩm
- ✅ Kiểm tra hợp đồng còn hiệu lực

#### 4.2. Kiểm tra số lượng

```cpp
bool KiemTraDuDieuKien(DoiTuong& obj, int yeuCau)
{
    if (obj.soLuong >= yeuCau)
        return true;
    
    cout << "Khong du! Chi con " << obj.soLuong << endl;
    return false;
}
```

**Ứng dụng:**
- ✅ Kiểm tra đủ sách để mượn
- ✅ Kiểm tra đủ hàng trong kho
- ✅ Kiểm tra đủ điểm để qua môn
- ✅ Kiểm tra đủ tuổi

#### 4.3. Kiểm tra điều kiện phức tạp

```cpp
bool KiemTraDieuKien(DoiTuong& obj, string loaiKiemTra)
{
    if (loaiKiemTra == "quahan")
        return KiemTraQuaHan(obj.ngayHetHan);
    else if (loaiKiemTra == "conhang")
        return obj.soLuong > 0;
    else if (loaiKiemTra == "active")
        return obj.trangThai == "HoatDong";
    // ... thêm điều kiện khác
    
    return false;
}
```

---

### 5. GHI LOG (UNIVERSAL LOGGING PATTERN)

```cpp
void GhiLog(string noidung)
{
    ofstream logFile("log.txt", ios::app);
    
    // Timestamp
    time_t now = time(0);
    tm* tm_ptr = localtime(&now);
    
    logFile << "[" << tm_ptr->tm_mday << "/" 
            << (tm_ptr->tm_mon + 1) << "/" 
            << (tm_ptr->tm_year + 1900) << " "
            << tm_ptr->tm_hour << ":" 
            << tm_ptr->tm_min << ":" 
            << tm_ptr->tm_sec << "] " 
            << noidung << endl;
    
    logFile.close();
}
```

**Các điểm nên ghi log:**
1. ✅ **Bắt đầu/Kết thúc chương trình**
2. ✅ **Đọc/Ghi file** (thành công/thất bại)
3. ✅ **User actions** (chọn gì, nhập gì)
4. ✅ **Cập nhật dữ liệu** (thay đổi gì)
5. ✅ **Điều kiện đặc biệt** (quá hạn, lỗi, warning)
6. ✅ **Exception** (lỗi gì, ở đâu)

---

## 📚 VÍ DỤ ỨNG DỤNG CỤ THỂ

### Ví dụ 1: Quản lý Thư viện

```cpp
struct Sach {
    string maSach;
    string tenSach;
    string theLoai;
    string tenDocGia;
    int soLuong;
    string tinhTrang;
};

struct PhieuMuon {
    string ngayMuon;
    string ngayTra;
    string docGia;
    string sach;
};

// Nghiệp vụ đặc thù:
// - Mượn sách: giảm soLuong, ghi phiếu
// - Trả sách: tăng soLuong, kiểm tra quá hạn
// - Tìm theo: tên sách, độc giả, thể loại
```

### Ví dụ 2: Quản lý Sinh viên

```cpp
struct SinhVien {
    string maSV;
    string hoTen;
    string nganh;
    string giangVien;
    int diem;
    string xepLoai;
};

struct DangKy {
    string ngayDangKy;
    string ngayKetThuc;
    string sinhVien;
    string monHoc;
};

// Nghiệp vụ đặc thù:
// - Đăng ký môn: kiểm tra điều kiện, ghi phiếu
// - Nhập điểm: cập nhật điểm, tính xếp loại
// - Tìm theo: mã SV, ngành, giảng viên
// - Kiểm tra: đủ điểm, quá deadline
```

### Ví dụ 3: Quản lý Kho hàng

```cpp
struct SanPham {
    string maSP;
    string tenSP;
    string danhMuc;
    string nhaCungCap;
    int soLuongKho;
    string tinhTrang;
};

struct PhieuXuat {
    string ngayXuat;
    string ngayGiaoHang;
    string khachHang;
    string sanPham;
};

// Nghiệp vụ đặc thù:
// - Xuất kho: giảm số lượng, ghi phiếu
// - Nhập kho: tăng số lượng
// - Tìm theo: tên SP, danh mục, NCC
// - Cảnh báo: hết hàng, tồn kho lâu
```

### Ví dụ 4: Quản lý Xe

```cpp
struct Xe {
    string bienSo;
    string tenXe;
    string loaiXe;
    string chuXe;
    int namSanXuat;
    string trangThai;
};

struct PhieuBaoTri {
    string ngayBatDau;
    string ngayKetThuc;
    string bienSo;
    string lyDo;
};

// Nghiệp vụ đặc thù:
// - Đăng ký bảo trì: đổi trạng thái, ghi phiếu
// - Hoàn thành bảo trì: đổi về trạng thái cũ
// - Tìm theo: biển số, loại xe, chủ xe
// - Kiểm tra: quá hạn đăng kiểm
```

---

## 🔄 MAIN TEMPLATE TỔNG QUÁT

```cpp
int main()
{
    GhiLog("=== BAT DAU ===");
    
    // ============ KHAI BÁO BIẾN ============
    // Biến điều khiển
    string luaChon;
    int giaTri = 0;
    bool daThucHien = false;
    string itemDaChon = "";
    
    // Quản lý dữ liệu
    int dem = 0;              // ← CRITICAL: Khởi tạo = 0
    int maxItems = 100;
    DoiTuong* ds = new DoiTuong[maxItems];
    GiaoDich* phieu = new GiaoDich;
    
    // ============ ĐỌC DỮ LIỆU ============
    DocFile(ds, dem);
    
    // Kiểm tra dữ liệu rỗng
    if (dem == 0)
    {
        cout << "Khong co du lieu!" << endl;
        GhiLog("Khong co du lieu.");
        delete[] ds;
        delete phieu;
        return 0;
    }
    
    // ============ XỬ LÝ NGHIỆP VỤ ============
    // 1. Tìm kiếm & Chọn
    TimKiemVaChon(ds, phieu, dem, luaChon, giaTri, 
                  daThucHien, itemDaChon);
    
    // 2. Cập nhật dữ liệu
    CapNhat(ds, dem, itemDaChon, giaTri, daThucHien);
    
    // 3. Kiểm tra điều kiện (nếu có)
    KiemTraDieuKien(phieu);
    
    // 4. Ghi kết quả
    GhiPhieu(phieu);
    
    // ============ GIẢI PHÓNG BỘ NHỚ ============
    delete[] ds;
    delete phieu;
    ds = nullptr;
    phieu = nullptr;
    
    GhiLog("=== KET THUC ===");
    return 0;
}
```

---

## 💡 TIPS & TRICKS TỔNG QUÁT

### 1. Khởi tạo an toàn

```cpp
// LUÔN khởi tạo counter = 0
int dem = 0;  // ← Sẽ được cập nhật khi đọc file

// SAI:
int dem = 100;  // ← Sẽ ghi 100 dòng rác!
```

### 2. Parse string linh hoạt

```cpp
// Cho BẤT KỲ delimiter nào
vector<string> Split(string str, char delimiter)
{
    vector<string> result;
    string current = "";
    
    for (char c : str)
    {
        if (c == delimiter)
        {
            result.push_back(current);
            current = "";
        }
        else
            current += c;
    }
    result.push_back(current);  // Phần cuối
    
    return result;
}

// Sử dụng:
auto parts = Split("item1,item2,item3", ',');
auto parts2 = Split("a;b;c", ';');
```

### 3. Validate input

```cpp
// Template validation
template<typename T>
T NhapVoiValidation(string prompt, T min, T max)
{
    T value;
    do {
        cout << prompt;
        cin >> value;
        
        if (value < min || value > max)
            cout << "Gia tri khong hop le! Nhap lai." << endl;
            
    } while (value < min || value > max);
    
    return value;
}

// Sử dụng:
int sl = NhapVoiValidation("Nhap so luong: ", 1, 100);
```

### 4. Tìm kiếm linh hoạt

```cpp
// Tìm index của item
int TimIndex(DoiTuong* ds, int dem, string id)
{
    for (int i = 0; i < dem; i++)
        if (ds[i].id == id)
            return i;
    return -1;  // Không tìm thấy
}

// Đếm số lượng match
int Dem(DoiTuong* ds, int dem, string field, string value)
{
    int count = 0;
    for (int i = 0; i < dem; i++)
        if (GetField(ds[i], field) == value)
            count++;
    return count;
}
```

### 5. Format output đẹp

```cpp
#include <iomanip>

void HienThiBang(DoiTuong* ds, int dem)
{
    cout << string(80, '=') << endl;
    cout << left << setw(10) << "ID" 
         << setw(30) << "Ten"
         << setw(20) << "Loai"
         << "So luong" << endl;
    cout << string(80, '-') << endl;
    
    for (int i = 0; i < dem; i++)
    {
        cout << left << setw(10) << ds[i].id
             << setw(30) << ds[i].ten
             << setw(20) << ds[i].loai
             << ds[i].soLuong << endl;
    }
    
    cout << string(80, '=') << endl;
}
```

---

## 🚨 CHECKLIST TRƯỚC KHI NỘP BÀI

- [ ] ✅ `dem` được khởi tạo = 0
- [ ] ✅ Đọc file có fallback (thử nhiều vị trí)
- [ ] ✅ Parse CSV xử lý được nhiều delimiter
- [ ] ✅ Cập nhật CHỈ item được chọn (có `break`)
- [ ] ✅ Ghi file chỉ ghi `dem` dòng (không phải maxItems)
- [ ] ✅ Validate input từ user
- [ ] ✅ Try-catch ở mọi I/O operation
- [ ] ✅ Ghi log đầy đủ
- [ ] ✅ Giải phóng bộ nhớ động
- [ ] ✅ Set pointer = nullptr sau delete
- [ ] ✅ Code comment rõ ràng
- [ ] ✅ Test với nhiều trường hợp

---

## 📖 TÀI LIỆU THAM KHẢO

### Các file cần có:
```
project/
├── data.txt          // Dữ liệu chính
├── transactions.txt  // Giao dịch/Phiếu
├── log.txt          // Log (tự động tạo)
└── main.cpp         // Source code
```

### Format data.txt mẫu:
```
ID001,TenItem1,LoaiA,Nguoi1,100,Active
ID002,TenItem2,LoaiB,Nguoi2,50,Inactive
ID003,TenItem3,LoaiA,Nguoi1,75,Active
```

---

*Last updated: 2025*
*Template for: Library, Inventory, Student Management, and more*
